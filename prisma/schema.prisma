// Prisma Schema - Provision WorkSuite
// Updated: 2024-12-10

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS FOR DATA INTEGRITY
// =============================================================================

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum TaskStatus {
  todo
  in_progress
  done
  blocked
}

enum ProjectStatus {
  active
  completed
  on_hold
  cancelled
}

enum InvoiceStatus {
  draft
  sent
  paid
  overdue
  cancelled
}

// =============================================================================
// USER & AUTHENTICATION
// =============================================================================

model User {
  id           Int      @id @default(autoincrement())
  uid          String   @unique @default(uuid())
  email        String   @unique
  name         String
  avatarUrl    String?  @map("avatar_url")
  role         String   @default("member")
  passwordHash String?  @map("password_hash")
  phone        String?
  bio          String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  country      String?
  postalCode   String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Two-Factor Authentication
  twoFactorEnabled    Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret     String?   @map("two_factor_secret") // Encrypted TOTP secret
  backupCodes         String[]  @default([]) @map("backup_codes") // Hashed backup codes
  twoFactorVerifiedAt DateTime? @map("two_factor_verified_at")

  // Optional FK to Role model
  roleId  String? @map("role_id")
  roleRef Role?   @relation(fields: [roleId], references: [id], onDelete: SetNull)

  // Session Management
  sessions Session[]

  // Relations
  projects             Project[]
  projectMemberships   ProjectMember[]
  comments             Comment[]
  notifications        Notification[]
  activities           Activity[]
  uploadedFiles        File[]
  createdEvents        CalendarEvent[]
  assignedTasks        Task[]            @relation("TaskAssignee")
  chatGroupMemberships ChatGroupMember[]
  accounts             Account[]

  @@index([email])
  @@index([roleId])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       Int      @map("user_id")
  token        String   @unique // The JWT token signature or a session ID
  deviceInfo   String?  @map("device_info") // User agent string
  ipAddress    String?  @map("ip_address")
  location     String? // City, Country (parsed from IP)
  createdAt    DateTime @default(now()) @map("created_at")
  expiresAt    DateTime @map("expires_at")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  isValid      Boolean  @default(true) @map("is_valid")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model Account {
  id                String   @id @default(cuid())
  userId            Int      @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  createdAt         DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  colorHex    String?  @map("color_hex")
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users User[]

  @@map("roles")
}

// =============================================================================
// PROJECT MANAGEMENT
// =============================================================================

model Project {
  id          Int       @id @default(autoincrement())
  uid         String    @unique @default(uuid())
  name        String
  description String?
  status      String    @default("active")
  startDate   DateTime? @map("start_date")
  deadline    DateTime?
  budget      Float?
  priority    String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // New fields
  completedAt DateTime? @map("completed_at")
  clientName  String?   @map("client_name")
  tags        String[]  @default([])
  visibility  String    @default("private") // public, private, team-only
  archivedAt  DateTime? @map("archived_at")
  color       String?

  // Creator/Owner reference (legacy support)
  userId Int  @map("user_id")
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations - tasks linked via projectId=uid
  tasks      Task[]
  expenses   Expense[]
  invoices   Invoice[]
  milestones Milestone[]
  files      File[]
  comments   Comment[]
  events     CalendarEvent[]
  members    ProjectMember[]

  @@index([userId])
  @@index([status])
  @@index([visibility])
  @@index([archivedAt])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(uuid())
  projectId Int      @map("project_id")
  userId    Int      @map("user_id")
  role      String   @default("member") // owner, admin, member, viewer
  joinedAt  DateTime @default(now()) @map("joined_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

model Milestone {
  id          String    @id @default(uuid())
  projectId   Int       @map("project_id")
  name        String
  description String?
  dueDate     DateTime? @map("due_date")
  status      String    @default("pending") // pending, in-progress, completed
  order       Int       @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@map("milestones")
}

// =============================================================================
// TASK MANAGEMENT
// =============================================================================

model Task {
  id            Int       @id @default(autoincrement())
  uid           String    @unique @default(uuid())
  projectId     String    @map("project_id")
  title         String
  description   String?
  status        String    @default("todo")
  priority      String    @default("medium")
  due           DateTime?
  estimateHours Float?    @map("estimate_hours")
  loggedHours   Float     @default(0) @map("logged_hours")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // New fields
  assigneeId   Int?      @map("assignee_id")
  labels       String[]  @default([]) // bug, feature, urgent, etc.
  boardColumn  String    @default("todo") @map("board_column") // todo, in-progress, done, blocked
  order        Int       @default(0)
  parentTaskId String?   @map("parent_task_id")
  attachments  Json?
  completedAt  DateTime? @map("completed_at")
  startedAt    DateTime? @map("started_at")
  blockedBy    String?   @map("blocked_by") // Reference to Blocker id
  watchers     String[]  @default([]) // Array of user UIDs

  // Recurrence fields
  isRecurring Boolean @default(false) @map("is_recurring")
  templateId  String? @map("template_id") // Links to RecurringTaskTemplate

  // Relations - project linked via uid reference
  project    Project         @relation(fields: [projectId], references: [uid], onDelete: Cascade)
  assignee   User?           @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  parentTask Task?           @relation("TaskSubtasks", fields: [parentTaskId], references: [uid], onDelete: SetNull)
  subtasks   Task[]          @relation("TaskSubtasks")
  timeLogs   TimeLog[]
  comments   Comment[]
  files      File[]
  events     CalendarEvent[]

  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority])
  @@index([boardColumn])
  @@index([parentTaskId])
  @@index([due]) // For deadline queries and filtering
  @@index([createdAt]) // For chronological sorting
  @@map("tasks")
}

model TimeLog {
  id        Int      @id @default(autoincrement())
  taskId    String   @map("task_id")
  projectId String   @map("project_id")
  hours     Float
  note      String?
  loggedBy  String   @map("logged_by")
  loggedAt  DateTime @default(now()) @map("logged_at")

  // Relations
  task Task @relation(fields: [taskId], references: [uid], onDelete: Cascade)

  @@index([taskId])
  @@index([projectId])
  @@map("time_logs")
}

// =============================================================================
// COMMENTS & DISCUSSIONS
// =============================================================================

model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Polymorphic relation (task or project)
  taskId    String? @map("task_id")
  projectId Int?    @map("project_id")
  userId    Int     @map("user_id")

  // Threading support
  parentCommentId String? @map("parent_comment_id")

  // Relations
  task          Task?     @relation(fields: [taskId], references: [uid], onDelete: Cascade)
  project       Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentComment Comment?  @relation("CommentThread", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies       Comment[] @relation("CommentThread")

  @@index([taskId])
  @@index([projectId])
  @@index([userId])
  @@index([parentCommentId])
  @@map("comments")
}

// =============================================================================
// NOTIFICATIONS & ACTIVITY
// =============================================================================

model Notification {
  id        String   @id @default(uuid())
  userId    Int      @map("user_id")
  type      String // task_assigned, comment_added, deadline_reminder, etc.
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Activity {
  id         String   @id @default(uuid())
  userId     Int      @map("user_id")
  entityType String   @map("entity_type") // project, task, comment, file, etc.
  entityId   String   @map("entity_id")
  action     String // created, updated, deleted, assigned, commented, etc.
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activities")
}

// =============================================================================
// FILE MANAGEMENT
// =============================================================================

model File {
  id        String   @id @default(uuid())
  filename  String
  fileUrl   String   @map("file_url")
  fileSize  Int      @map("file_size")
  mimeType  String   @map("mime_type")
  createdAt DateTime @default(now()) @map("created_at")

  // Optional associations
  projectId  Int?    @map("project_id")
  taskId     String? @map("task_id")
  uploadedBy Int     @map("uploaded_by")

  // Relations
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  task     Task?    @relation(fields: [taskId], references: [uid], onDelete: SetNull)
  uploader User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([taskId])
  @@index([uploadedBy])
  @@map("files")
}

// =============================================================================
// CALENDAR & SCHEDULING
// =============================================================================

model CalendarEvent {
  id          String   @id @default(uuid())
  title       String
  description String?
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  location    String?
  attendees   String[] @default([]) // Array of user UIDs
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Optional associations
  projectId   Int?    @map("project_id")
  taskId      String? @map("task_id")
  createdById Int     @map("created_by_id")

  // Relations
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  task      Task?    @relation(fields: [taskId], references: [uid], onDelete: SetNull)
  createdBy User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([taskId])
  @@index([createdById])
  @@index([startTime])
  @@map("calendar_events")
}

// =============================================================================
// FINANCIAL
// =============================================================================

model Expense {
  id        Int      @id @default(autoincrement())
  uid       String   @unique @default(uuid())
  projectId Int      @map("project_id")
  date      DateTime
  vendor    String?
  amount    Float
  category  String?
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
  @@map("expenses")
}

model Invoice {
  id         Int      @id @default(autoincrement())
  uid        String   @unique @default(uuid())
  projectId  Int      @map("project_id")
  clientName String   @map("client_name")
  issueDate  DateTime @map("issue_date")
  dueDate    DateTime @map("due_date")
  status     String   @default("draft") // draft, sent, paid, overdue, cancelled
  items      Json
  total      Float
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// =============================================================================
// BLOCKERS & RISKS
// =============================================================================

model BlockerCategory {
  id                String @id // kebab-case id
  label             String
  defaultOwnerGroup String @map("default_owner_group")
  slaDays           Int    @default(7) @map("sla_days")
  iconEmoji         String @map("icon_emoji")

  // Relations
  blockers Blocker[]

  @@map("blocker_categories")
}

model Blocker {
  id            String    @id @default(uuid())
  title         String
  description   String?
  level         String // low, medium, high, critical
  status        String // open, resolved
  impactedTasks String?   @map("impacted_tasks") // JSON array of task ids
  assignedTo    String?   @map("assigned_to")
  reportedBy    String    @map("reported_by")
  reportedDate  DateTime  @map("reported_date")
  resolvedDate  DateTime? @map("resolved_date")
  resolution    String?
  categoryId    String    @map("category")
  projectId     String?   @map("project_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  category BlockerCategory @relation(fields: [categoryId], references: [id])

  @@index([projectId])
  @@index([status])
  @@index([categoryId])
  @@map("blockers")
}

// =============================================================================
// CHAT & MESSAGING
// =============================================================================

model Message {
  id        Int      @id @default(autoincrement())
  fromUser  String   @map("from_user")
  toUser    String   @map("to_user")
  message   String
  createdAt DateTime @default(now()) @map("created_at")
  isRead    Boolean  @default(false) @map("is_read")

  @@index([fromUser])
  @@index([toUser])
  @@map("messages")
}

model ChatGroup {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations - Many-to-many through junction table
  members ChatGroupMember[]

  @@map("chat_groups")
}

model ChatGroupMember {
  id          String   @id @default(uuid())
  chatGroupId String   @map("chat_group_id")
  userId      Int      @map("user_id")
  joinedAt    DateTime @default(now()) @map("joined_at")

  // Relations
  chatGroup ChatGroup @relation(fields: [chatGroupId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatGroupId, userId])
  @@index([chatGroupId])
  @@index([userId])
  @@map("chat_group_members")
}

model Presence {
  uid      String   @id
  status   String
  lastSeen DateTime @default(now()) @map("last_seen")

  @@index([status])
  @@map("presence")
}

// =============================================================================
// SYSTEM
// =============================================================================

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model SystemSetting {
  id           Int      @id @default(autoincrement())
  settingKey   String   @unique @map("setting_key")
  settingValue String   @map("setting_value")
  isEncrypted  Boolean  @default(true) @map("is_encrypted")
  updatedAt    DateTime @default(now()) @map("updated_at")
  updatedBy    String?  @map("updated_by")

  @@index([settingKey])
  @@map("system_settings")
}

// =============================================================================
// RECURRING TASKS
// =============================================================================

model RecurringTaskTemplate {
  id            String   @id @default(uuid())
  title         String
  description   String?
  projectId     String   @map("project_id")
  assigneeId    Int?     @map("assignee_id")
  priority      String   @default("medium")
  labels        String[] @default([])
  estimateHours Float?   @map("estimate_hours")

  // Recurrence configuration
  recurrenceRule  String    @map("recurrence_rule") // RRULE: FREQ=DAILY|WEEKLY|MONTHLY;INTERVAL=1;BYDAY=MO,WE,FR
  nextRun         DateTime  @map("next_run")
  lastRun         DateTime? @map("last_run")
  endDate         DateTime? @map("end_date")
  occurrences     Int? // Max number of occurrences, null = infinite
  occurrenceCount Int       @default(0) @map("occurrence_count")

  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById Int      @map("created_by_id")

  @@index([projectId])
  @@index([nextRun])
  @@index([isActive])
  @@map("recurring_task_templates")
}
